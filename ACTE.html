<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8" />
    <title>ACTE Survey Form</title>
    <!-- Include SheetJS for Excel Export -->
    <script src="https://cdn.sheetjs.com/xlsx-latest/package/dist/xlsx.full.min.js"></script>
    <style>
        body {
            font-family: "Segoe UI", Arial, sans-serif;
            background: #ffffff;
            color: #333;
            padding: 20px;
            margin: 0;
        }

        .container {
            max-width: 1200px;
            margin: auto;
        }

        h2 {
            margin-bottom: 20px;
            font-size: 20px;
        }

        h3 {
            font-size: 16px;
            margin: 25px 0 10px 0;
            color: #000;
        }

        .card {
            background: #fff;
            border: 1px solid #e0e0e0;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 20px;
            /* box-shadow: 0 1px 3px rgba(0,0,0,0.05); */
            /* Screenshot looks cleaner/flatter, maybe remove shadow or keep light */
        }

        .section-header {
            font-weight: 700;
            font-size: 15px;
            margin-bottom: 15px;
            color: #000;
            display: block;
        }

        /* Form Layout Utils */
        .row {
            display: flex;
            gap: 20px;
            margin-bottom: 15px;
            align-items: flex-start;
        }

        .col {
            flex: 1;
            display: flex;
            flex-direction: column;
        }

        .col-half {
            flex: 0 0 50%;
            max-width: 50%;
        }

        /* Rough approximations */

        label {
            font-size: 12px;
            font-weight: 600;
            margin-bottom: 6px;
            color: #444;
        }

        input[type="text"],
        input[type="email"],
        select {
            width: 100%;
            padding: 10px 12px;
            border: 1px solid #dcdcdc;
            border-radius: 4px;
            box-sizing: border-box;
            font-size: 14px;
            background-color: #fff;
            height: 42px;
            /* Fixed height for consistency */
        }

        input:focus,
        select:focus {
            border-color: #2196F3;
            outline: none;
        }

        input:disabled {
            background-color: #f5f5f5;
            color: #666;
        }

        .helper-text {
            font-size: 11px;
            color: #888;
            margin-top: 4px;
            display: block;
        }

        /* Checkbox Grids */
        .q-label {
            font-weight: 600;
            font-size: 14px;
            margin-bottom: 10px;
            display: block;
            color: #444;
        }

        .checkbox-grid {
            display: flex;
            flex-wrap: wrap;
            gap: 15px 30px;
        }

        .checkbox-item {
            display: flex;
            align-items: center;
            gap: 8px;
            min-width: 40px;
        }

        .checkbox-item input {
            width: 16px;
            height: 16px;
            margin: 0;
            cursor: pointer;
        }

        .number-grid {
            display: grid;
            grid-template-columns: repeat(12, 1fr);
            gap: 10px;
        }

        /* Sub-sections within Q12 */
        .sub-group {
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 1px dashed #eee;
        }

        .sub-title {
            font-size: 13px;
            font-weight: 700;
            margin-bottom: 8px;
        }

        .buttons {
            display: flex;
            gap: 10px;
            margin-top: 30px;
            padding-top: 20px;
            border-top: 1px solid #eee;
        }

        button {
            padding: 10px 20px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            color: white;
            font-weight: 600;
        }

        .btn-submit {
            background: #2196F3;
        }

        .btn-clear {
            background: #f0f0f0;
            color: #333;
            border: 1px solid #ccc;
        }

        .btn-download {
            background: #4CAF50;
        }

        .btn-delete {
            background: #F44336;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
            font-size: 13px;
        }

        th,
        td {
            border-bottom: 1px solid #eee;
            padding: 10px;
            text-align: left;
        }

        th {
            font-weight: 600;
            background: #f9f9f9;
        }
    </style>
</head>

<body>
    <div class="container">

        <!-- FIXED SURVEY INFO -->
        <div class="card">
            <span class="section-header">Fixed Survey Info</span>
            <div class="row">
                <div class="col">
                    <label>SurveyYear (Fixed)</label>
                    <input type="text" id="SurveyYear" maxlength="4" value="2025" disabled>
                </div>
                <div class="col">
                    <label>SurveyType (Fixed)</label>
                    <input type="text" id="SurveyTyp" maxlength="2" value="HC" disabled>
                </div>
                <div class="col">
                    <label>EVID (exactly 9 chars)</label>
                    <input type="text" id="EVID" maxlength="9">
                    <span class="helper-text">Must be exactly 9 characters.</span>
                </div>
                <div class="col">
                    <label>Form (exactly 5 chars)</label>
                    <input type="text" id="Form" maxlength="5">
                    <span class="helper-text">Must be exactly 5 characters.</span>
                </div>
            </div>
        </div>

        <!-- STUDENT DETAILS -->
        <div class="card">
            <span class="section-header">Student Details</span>

            <!-- Row 1: Name -->
            <div class="row">
                <div class="col">
                    <label>First name</label>
                    <input type="text" id="FirstName" maxlength="40">
                </div>
                <div class="col">
                    <label>Middle Initial</label>
                    <input type="text" id="MiddleInitial" maxlength="1">
                </div>
                <div class="col">
                    <label>Last name</label>
                    <input type="text" id="LastName" maxlength="40">
                </div>
                <div class="col">
                    <label>Suffix</label>
                    <input type="text" id="Suffix" maxlength="8">
                </div>
            </div>

            <!-- Row 2: Address -->
            <div class="row">
                <div class="col">
                    <label>Address</label>
                    <input type="text" id="Address" maxlength="64">
                </div>
            </div>

            <!-- Row 3: Address 2 -->
            <div class="row">
                <div class="col">
                    <label>Address 2</label>
                    <input type="text" id="Address2" maxlength="64">
                </div>
            </div>

            <!-- Row 4: City, State, ZIP -->
            <div class="row">
                <div class="col">
                    <label>City</label>
                    <input type="text" id="City" maxlength="64">
                </div>
                <div class="col">
                    <label>State (2 chars)</label>
                    <input type="text" id="State" maxlength="2">
                </div>
                <div class="col">
                    <label>ZIP (5 chars)</label>
                    <input type="text" id="Zip" maxlength="5">
                </div>
                <div class="col">
                    <label>ZIP4 (4 chars)</label>
                    <input type="text" id="Zip4" maxlength="4">
                </div>
            </div>

            <!-- Row 5: Gender, GradYear, GPA -->
            <div class="row">
                <div class="col">
                    <label>Gender</label>
                    <select id="Gender">
                        <option value="">--select--</option>
                        <option value="Male">Male</option>
                        <option value="Female">Female</option>
                        <option value="Another Gender">Another Gender</option>
                    </select>
                </div>
                <div class="col">
                    <label>GradYear</label>
                    <select id="GradYearSelect" onchange="document.getElementById('GradYear').value=this.value">
                        <option value="">--select--</option>
                        <script>
                            for (let y = 2025; y <= 2030; y++) document.write(`<option value="${y}">${y}</option>`);
                        </script>
                    </select>
                    <!-- Hidden input to store if needed or just use select value directly in storage -->
                    <input type="hidden" id="GradYear">
                </div>
                <div class="col">
                    <label>GPA</label>
                    <select id="GPASelect" onchange="document.getElementById('GPA').value=this.value">
                        <option value="">--select--</option>
                        <option value="A+">A+</option>
                        <option value="A">A</option>
                        <option value="A-">A-</option>
                        <option value="B+">B+</option>
                        <option value="B">B</option>
                        <option value="B-">B-</option>
                        <option value="C+">C+</option>
                        <option value="C">C</option>
                        <option value="LC">LC</option>
                    </select>
                    <input type="hidden" id="GPA">
                </div>
            </div>

            <!-- Row 6: Birth Date, Email -->
            <div class="row">
                <div class="col" style="flex: 0 0 auto; min-width: 300px;">
                    <label>Birth (MM / DD / YYYY)</label>
                    <div style="display: flex; gap: 10px;">
                        <input type="text" id="BirthMonth" maxlength="2" placeholder="MM"
                            style="width: 60px; text-align:center;" onchange="validateDate(this, 1, 12, 'Month')">
                        <input type="text" id="BirthDay" maxlength="2" placeholder="DD"
                            style="width: 60px; text-align:center;" onchange="validateDate(this, 1, 31, 'Day')">
                        <input type="text" id="BirthYear" maxlength="4" placeholder="YYYY"
                            style="width: 80px; text-align:center;" onchange="validateDate(this, 2005, 2012, 'Year')">
                    </div>
                    <span class="helper-text">Month 01-12, Day 01-31, Year 2005-2012</span>
                </div>
                <div class="col" style="flex: 1;">
                    <label>Email</label>
                    <input type="email" id="Email" maxlength="255">
                </div>
            </div>

            <!-- Row 7: MobilePhone, TeacherLastName -->
            <div class="row">
                <div class="col">
                    <label>MobilePhone (10 chars)</label>
                    <input type="text" id="MobilePhone" maxlength="10">
                </div>
                <div class="col">
                    <label>TeacherLastName</label>
                    <input type="text" id="TeacherLastName" maxlength="30">
                </div>
            </div>
        </div>

        <!-- Questions Card (retained style from previous step) -->
        <div class="card">
            <span class="section-header">Questions</span>
            <span class="q-label">1 (A-H)</span>
            <div class="checkbox-grid">
                <script>for (let c of "ABCDEFGH") document.write(`<label class="checkbox-item"><input type="radio" name="radio_Q1" value="${c}" onclick="setVal('Q1', '${c}')"> <span>${c}</span></label>`)</script>
            </div>
            <input type="hidden" id="Q1">

            <hr style="border: 0; border-top: 1px solid #eee; margin: 20px 0;">

            <span class="q-label">2 (A-C)</span>
            <div class="checkbox-grid">
                <script>for (let c of "ABC") document.write(`<label class="checkbox-item"><input type="radio" name="radio_Q2" value="${c}" onclick="setVal('Q2', '${c}')"> <span>${c}</span></label>`)</script>
            </div>
            <input type="hidden" id="Q2">

            <hr style="border: 0; border-top: 1px solid #eee; margin: 20px 0;">

            <span class="q-label">3 (A-P)</span>
            <div class="checkbox-grid">
                <script>for (let c of "ABCDEFGHIJKLMNOP") document.write(`<label class="checkbox-item"><input type="radio" name="radio_Q3" value="${c}" onclick="setVal('Q3', '${c}')"> <span>${c}</span></label>`)</script>
            </div>
            <input type="hidden" id="Q3">

            <hr style="border: 0; border-top: 1px solid #eee; margin: 20px 0;">

            <span class="q-label">4 (A-G) All that apply</span>
            <div class="checkbox-grid">
                <script>for (let c of "ABCDEFG") document.write(`<label class="checkbox-item"><input type="checkbox" value="${c}" onchange="updateMulti('Q4', 7)"> <span>${c}</span></label>`)</script>
            </div>
            <input type="hidden" id="Q4">

            <hr style="border: 0; border-top: 1px solid #eee; margin: 20px 0;">

            <span class="q-label">5 (A - F) All that apply</span>
            <div class="checkbox-grid">
                <script>for (let c of "ABCDEF") document.write(`<label class="checkbox-item"><input type="checkbox" value="${c}" onchange="updateMulti('Q5', 6)"> <span>${c}</span></label>`)</script>
            </div>
            <input type="hidden" id="Q5">

            <!-- ... and so on for other questions, condensed into one card or separated as preferred. 
                  The user only provided Screenshot for TOP layout.
                  I will keep the Question styling from previous step but organized neatly. -->
            <hr style="border: 0; border-top: 1px solid #eee; margin: 20px 0;">
            <span class="q-label">6 (A, B, or blank)</span>
            <div class="checkbox-grid">
                <label class="checkbox-item"><input type="radio" name="radio_Q6" value="A" onclick="setVal('Q6', 'A')">
                    <span>A</span></label>
                <label class="checkbox-item"><input type="radio" name="radio_Q6" value="B" onclick="setVal('Q6', 'B')">
                    <span>B</span></label>
            </div>
            <input type="hidden" id="Q6">

            <hr style="border: 0; border-top: 1px solid #eee; margin: 20px 0;">

            <span class="q-label">7 (A-H) All that apply</span>
            <div class="checkbox-grid">
                <script>for (let c of "ABCDEFGH") document.write(`<label class="checkbox-item"><input type="checkbox" value="${c}" onchange="updateMulti('Q7', 8)"> <span>${c}</span></label>`)</script>
            </div>
            <input type="hidden" id="Q7">
            <hr style="border: 0; border-top: 1px solid #eee; margin: 20px 0;">

            <!-- Q8 - Q11 -->
            <span class="q-label">8 (A-H) Up to 3</span>
            <div class="checkbox-grid">
                <script>for (let c of "ABCDEFGH") document.write(`<label class="checkbox-item"><input type="checkbox" value="${c}" onchange="updateMulti('Q8', 3)"> <span>${c}</span></label>`)</script>
            </div>
            <input type="hidden" id="Q8">

            <hr style="border: 0; border-top: 1px solid #eee; margin: 20px 0;">

            <span class="q-label">9 (A-L) Up to 5</span>
            <div class="checkbox-grid">
                <script>for (let c of "ABCDEFGHIJKL") document.write(`<label class="checkbox-item"><input type="checkbox" value="${c}" onchange="updateMulti('Q9', 5)"> <span>${c}</span></label>`)</script>
            </div>
            <input type="hidden" id="Q9">

            <hr style="border: 0; border-top: 1px solid #eee; margin: 20px 0;">

            <span class="q-label">10 (A-S) All that apply</span>
            <div class="checkbox-grid">
                <script>for (let c of "ABCDEFGHIJKLMNOPQRS") document.write(`<label class="checkbox-item"><input type="checkbox" value="${c}" onchange="updateMulti('Q10', 19)"> <span>${c}</span></label>`)</script>
            </div>
            <input type="hidden" id="Q10">

            <hr style="border: 0; border-top: 1px solid #eee; margin: 20px 0;">

            <span class="q-label">11. Colleges/States</span>
            <div class="row">
                <div class="col"><label>11A (State)</label><input type="text" id="Q11A" maxlength="2"></div>
                <div class="col"><label>11B (State)</label><input type="text" id="Q11B" maxlength="2"></div>
                <div class="col"><label>11C (State)</label><input type="text" id="Q11C" maxlength="2"></div>
            </div>
            <hr style="border: 0; border-top: 1px solid #eee; margin: 20px 0;">

            <!-- Plans Q12 -->
            <span class="section-header">12. Plans</span>

            <div class="sub-group">
                <div class="sub-title">12A</div>
                <div class="row">
                    <div class="col" style="flex: 2;"><label>12A1 - College name</label><input type="text" id="Q12A1"
                            maxlength="50"></div>
                    <div class="col"><label>12A2 - State (2)</label><input type="text" id="Q12A2" maxlength="2">
                    </div>
                    <div class="col">
                        <label>12A3 - Yes/No</label>
                        <select id="Q12A3">
                            <option value="">--select--</option>
                            <option value="Y">Y</option>
                            <option value="N">N</option>
                        </select>
                    </div>
                </div>
            </div>

            <div class="sub-group">
                <div class="sub-title">12B</div>
                <div class="row">
                    <div class="col" style="flex: 2;"><label>12B1 - College name</label><input type="text" id="Q12B1"
                            maxlength="50"></div>
                    <div class="col"><label>12B2 - State (2)</label><input type="text" id="Q12B2" maxlength="2">
                    </div>
                    <div class="col">
                        <label>12B3 - Yes/No</label>
                        <select id="Q12B3">
                            <option value="">--select--</option>
                            <option value="Y">Y</option>
                            <option value="N">N</option>
                        </select>
                    </div>
                </div>
            </div>

            <div class="sub-group">
                <div class="sub-title">12C</div>
                <div class="row">
                    <div class="col" style="flex: 2;"><label>12C1 - College name</label><input type="text" id="Q12C1"
                            maxlength="50"></div>
                    <div class="col"><label>12C2 - State (2)</label><input type="text" id="Q12C2" maxlength="2">
                    </div>
                    <div class="col">
                        <label>12C3 - Yes/No</label>
                        <select id="Q12C3">
                            <option value="">--select--</option>
                            <option value="Y">Y</option>
                            <option value="N">N</option>
                        </select>
                    </div>
                </div>
            </div>
            <div class="sub-group" style="border:none;">
                <div class="sub-title">12D</div>
                <div class="row">
                    <div class="col" style="flex: 2;"><label>12D1 - College name</label><input type="text" id="Q12D1"
                            maxlength="50"></div>
                    <div class="col"><label>12D2 - State (2)</label><input type="text" id="Q12D2" maxlength="2">
                    </div>
                    <div class="col">
                        <label>12D3 - Yes/No</label>
                        <select id="Q12D3">
                            <option value="">--select--</option>
                            <option value="Y">Y</option>
                            <option value="N">N</option>
                        </select>
                    </div>
                </div>
            </div>
            <div class="sub-group" style="border:none;">
                <div class="sub-title">12E</div>
                <div class="row">
                    <div class="col" style="flex: 2;"><label>12E1 - College name</label><input type="text" id="Q12E1"
                            maxlength="50"></div>
                    <div class="col"><label>12E2 - State (2)</label><input type="text" id="Q12E2" maxlength="2">
                    </div>
                    <div class="col">
                        <label>12E3 - Yes/No</label>
                        <select id="Q12E3">
                            <option value="">--select--</option>
                            <option value="Y">Y</option>
                            <option value="N">N</option>
                        </select>
                    </div>
                </div>
            </div>
            <hr style="border: 0; border-top: 1px solid #eee; margin: 20px 0;">
            <!-- 13, 14, 15 -->
            <span class="q-label">13 (1-71) Up to 3 selections</span>
            <div class="number-grid">
                <script>for (let i = 1; i <= 71; i++) document.write(`<label class="checkbox-item"><input type="checkbox" value="${i}" onchange="updateMulti('Q13', 3)"> <span>${i}</span></label>`)</script>
            </div>
            <input type="hidden" id="Q13">

            <!-- Hidden inputs to maintain compatibility with Export Schema if needed, or handled in JS -->
            <input type="hidden" id="Q13A"><input type="hidden" id="Q13B"><input type="hidden" id="Q13C">

            <hr style="border: 0; border-top: 1px solid #eee; margin: 20px 0;">

            <span class="q-label">14 (A-T) Apply All</span>
            <div class="checkbox-grid">
                <script>for (let c of "ABCDEFGHIJKLMNOPQRST") document.write(`<label class="checkbox-item"><input type="checkbox" value="${c}" onchange="updateMulti('Q14', 20)"> <span>${c}</span></label>`)</script>
            </div>
            <input type="hidden" id="Q14">

            <hr style="border: 0; border-top: 1px solid #eee; margin: 20px 0;">

            <span class="q-label">15 (A-Q) Up to 5</span>
            <div class="checkbox-grid">
                <script>for (let c of "ABCDEFGHIJKLMNOPQ") document.write(`<label class="checkbox-item"><input type="checkbox" value="${c}" onchange="updateMulti('Q15', 5)"> <span>${c}</span></label>`)</script>
            </div>
            <input type="hidden" id="Q15">

            <hr style="border: 0; border-top: 1px solid #eee; margin: 20px 0;">

            <!-- Other -->
            <span class="q-label">16 (A-Z) Up to 2 selections</span>
            <div class="checkbox-grid">
                <script>for (let c of "ABCDEFGHIJKLMNOPQRSTUVWXYZ") document.write(`<label class="checkbox-item"><input type="checkbox" value="${c}" onchange="updateMulti('Q16', 2)"> <span>${c}</span></label>`)</script>
            </div>
            <input type="hidden" id="Q16">
            <input type="hidden" id="Q16A"><input type="hidden" id="Q16B">
            <hr style="border: 0; border-top: 1px solid #eee; margin: 20px 0;">
            <span class="q-label">17 (A-G) Apply All</span>
            <div class="checkbox-grid">
                <script>for (let c of "ABCDEFG") document.write(`<label class="checkbox-item"><input type="checkbox" value="${c}" onchange="updateMulti('Q17', 7)"> <span>${c}</span></label>`)</script>
            </div>
            <input type="hidden" id="Q17">

            <hr style="border: 0; border-top: 1px solid #eee; margin: 20px 0;">
            <div class="row">
                <div class="col">
                    <label>18 Email (256)</label>
                    <input type="email" id="Q18" maxlength="256">
                </div>
            </div>
            <div class="row">
                <div class="col" style="max-width: 150px;">
                    <label>19 (Y/N)</label>
                    <div style="display:flex; gap:10px; margin-top:5px;">
                        <label class="checkbox-item"><input type="radio" name="radio_Q19" value="Y"
                                onclick="setVal('Q19', 'Y')"> <span>Y</span></label>
                        <label class="checkbox-item"><input type="radio" name="radio_Q19" value="N"
                                onclick="setVal('Q19', 'N')"> <span>N</span></label>
                    </div>
                    <input type="hidden" id="Q19">
                </div>
            </div>
        </div>


        <div class="buttons">
            <button type="button" class="btn-submit" onclick="saveRecord()">Submit</button>
            <button type="button" class="btn-clear" onclick="clearForm()">Clear Form</button>
            <button type="button" class="btn-download" onclick="downloadExcel()">Download Excel</button>
            <button type="button" class="btn-delete" onclick="clearStorage()">Delete All Data</button>
        </div>

        <h3>Stored Records (<span id="recordCount">0</span>)</h3>
        <div style="overflow-x:auto;">
            <table id="recordsTable">
                <thead>
                    <tr id="tableHeader"></tr>
                </thead>
                <tbody id="tableBody"></tbody>
            </table>
        </div>
    </div>

    <!-- JS Handling -->
    <script>
        const STORAGE_KEY = 'ACTE_Survey_Data_UserDefined_V2';

        // Internal IDs matching HTML
        const ALL_FIELDS = [
            "SurveyYear", "SurveyTyp", "EVID", "Form",
            "FirstName", "MiddleInitial", "LastName", "Suffix",
            "Address", "Address2", "City", "State", "Zip", "Zip4",
            "Gender", "GradYear", "BirthMonth", "BirthDay", "BirthYear",
            "GPA", "Email", "MobilePhone", "TeacherLastName",
            "Q1", "Q2", "Q3", "Q4", "Q5", "Q6", "Q7", "Q8", "Q9", "Q10",
            "Q11A", "Q11B", "Q11C",
            "Q12A1", "Q12A2", "Q12A3",
            "Q12B1", "Q12B2", "Q12B3",
            "Q12C1", "Q12C2", "Q12C3",
            "Q12D1", "Q12D2", "Q12D3",
            "Q12E1", "Q12E2", "Q12E3",
            "Q13", "Q13A", "Q13B", "Q13C", // Added Q13, kept Q13A/B/C for compatibility
            "Q14", "Q15",
            "Q16", "Q16A", "Q16B",
            "Q17", "Q18", "Q19"
        ];

        // Define Output Column Order and Headers exactly as in output.xlsx
        const EXPORT_SCHEMA = [
            { id: "SurveyYear", header: "SurveyYear" },
            { id: "SurveyTyp", header: "SurveyType" }, // Header is SurveyType
            { id: "EVID", header: "EVID" },
            { id: "Form", header: "Form" },
            { id: "FirstName", header: "FirstName" },
            { id: "MiddleInitial", header: "MiddleInitial" },
            { id: "LastName", header: "LastName" },
            { id: "Suffix", header: "Suffix" },
            { id: "Address", header: "Address" },
            { id: "Address2", header: "Address2" },
            { id: "City", header: "City" },
            { id: "State", header: "State" },
            { id: "Zip", header: "Zip" },
            { id: "Zip4", header: "Zip4" },
            { id: "Gender", header: "Gender" },
            { id: "GradYear", header: "GradYear" },
            { id: "BirthMonth", header: "BirthMonth" },
            { id: "BirthDay", header: "BirthDay" },
            { id: "BirthYear", header: "BirthYear" },
            { id: "GPA", header: "GPA" },
            { id: "Email", header: "Email" },
            { id: "MobilePhone", header: "MobilePhone" },
            { id: "TeacherLastName", header: "TeacherLastName" },

            // Questions in specific order
            { id: "Q5", header: "5" },
            { id: "Q6", header: "6" },
            { id: "Q7", header: "7" },
            { id: "Q8", header: "8" },
            { id: "Q13A", header: "13A" },
            { id: "Q13B", header: "13B" },
            { id: "Q13C", header: "13C" },
            { id: "Q10", header: "10" },
            { id: "Q14", header: "14" },
            { id: null, header: "Activity" }, // Unnamed: 32
            { id: "Q9", header: "9" },
            { id: "Q15", header: "15" },
            { id: "Q16A", header: "16A" },
            { id: "Q16B", header: "16B" },
            { id: null, header: "Envir" }, // Unnamed: 37
            { id: null, header: "MPlanInfo" }, // Unnamed: 38
            { id: null, header: "Mbranch" }, // Unnamed: 39
            { id: "Q17", header: "17" },
            { id: "Q11A", header: "11A" },
            { id: "Q11B", header: "11B" },
            { id: "Q11C", header: "11C" },
            { id: "Q12A1", header: "12A1" },
            { id: "Q12A2", header: "12A2" },
            { id: "Q12A3", header: "12A3" },
            { id: "Q12B1", header: "12B1" },
            { id: "Q12B2", header: "12B2" },
            { id: "Q12B3", header: "12B3" },
            { id: "Q12C1", header: "12C1" },
            { id: "Q12C2", header: "12C2" },
            { id: "Q12C3", header: "12C3" },
            { id: "Q12D1", header: "12D1" },
            { id: "Q12D2", header: "12D2" },
            { id: "Q12D3", header: "12D3" },
            { id: "Q12E1", header: "12E1" }, // Not in form, but in output
            { id: "Q12E2", header: "12E2" },
            { id: "Q12E3", header: "12E3" },
            { id: "Q19", header: "19" },
            { id: null, header: "ParentEmail" }, // Unnamed: 60
            { id: "Q1", header: "1" },
            { id: "Q2", header: "2" },
            { id: "Q3", header: "3" },
            { id: "Q4", header: "4" },
            { id: "StartTime", header: "Start Time" },
            { id: "EndTime", header: "End Time" }
        ];

        const FIELD_MAP = [
            ["ID", "id_idx"],
            ["SurveyTyp", "SurveyTyp"],
            ["EVID", "EVID"],
            ["Form", "Form"],
            ["Name", "Name"],
            ["Email", "Email"]
        ];

        let startTime;
        let editingIndex = -1;

        window.onload = function () {
            startTime = new Date();
            renderTable();
        };

        function setVal(id, value) {
            document.getElementById(id).value = value;
        }

        function validateDate(input, min, max, type) {
            const val = parseInt(input.value);
            if (isNaN(val) || val < min || val > max) {
                alert(`Invalid ${type}. Please enter a value between ${min} and ${max}.`);
                input.value = "";
            }
        }


        function updateMulti(fieldId, maxSelections) {
            const container = event.target.closest('.checkbox-grid, .number-grid');
            if (!container) return;
            const checkboxes = container.querySelectorAll("input[type='checkbox']");
            const checked = Array.from(checkboxes).filter(c => c.checked);

            if (maxSelections < checkboxes.length && checked.length > maxSelections) {
                alert(`For ${fieldId}, select up to ${maxSelections}.`);
                event.target.checked = false;
                return;
            }
            const delimiter = (fieldId === 'Q13') ? "," : "";
            document.getElementById(fieldId).value = checked.map(c => c.value).join(delimiter);
        }

        function getFormData() {
            const data = {};
            ALL_FIELDS.forEach(id => {
                const el = document.getElementById(id);
                data[id] = el ? el.value.trim() : "";
            });

            // Composite fields for display
            data.Name = (data.FirstName || "") + " " + (data.LastName || "");
            data.BirthDate = (data.BirthMonth || "") + "/" + (data.BirthDay || "") + "/" + (data.BirthYear || "");

            // Q13 Splitting Logic
            const q13Val = document.getElementById('Q13') ? document.getElementById('Q13').value : "";
            if (q13Val) {
                const parts = q13Val.split(',');
                if (parts[0]) data['Q13A'] = parts[0];
                if (parts[1]) data['Q13B'] = parts[1];
                if (parts[2]) data['Q13C'] = parts[2];
            }

            // Q16 Splitting Logic
            const q16Val = document.getElementById('Q16') ? document.getElementById('Q16').value : "";
            if (q16Val) {
                // Q16 is comma separated by default from updateMulti logic for consistency?
                // Wait, Q4 and Q13 used comma. Others default?
                // "const delimiter = (fieldId === 'Q4' || fieldId === 'Q13') ? ',' : '';"
                // I need to make sure Q16 uses comma if I want to split easily, OR just use empty string logic if it's single chars?
                // A-Z are single chars. "AB" is easier to split than "A,B" if we just want 1st/2nd char?
                // But "AB" -> data['Q16A']=A, data['Q16B']=B.
                // If updateMulti uses empty string delimiter (default for others), value is "AB".
                // Then parts[0] is A, parts[1] is B. Correct.

                // HOWEVER, updateMulti logic:
                // const delimiter = (fieldId === 'Q13') ? "," : "";
                // Checks for 'Q13' specifically. Q4 I removed comma.
                // So Q16 will be empty string delimiter "scan A B" -> "AB".

                if (q16Val.length > 0) data['Q16A'] = q16Val.charAt(0);
                if (q16Val.length > 1) data['Q16B'] = q16Val.charAt(1);
            }

            data.Timestamp = new Date().toISOString();
            data.StartTime = startTime ? startTime.toLocaleString() : "";
            data.EndTime = new Date().toLocaleString();
            return data;
        }

        function saveRecord() {
            const data = getFormData();

            // Validation: EVID (9 chars) and Form (5 chars)
            if (!data.EVID || data.EVID.length !== 9) {
                alert("EVID is mandatory and must be exactly 9 characters.");
                return;
            }
            if (!data.Form || data.Form.length !== 5) {
                alert("Form is mandatory and must be exactly 5 characters.");
                return;
            }

            const records = JSON.parse(localStorage.getItem(STORAGE_KEY) || "[]");

            if (editingIndex > -1) {
                // Update existing
                records[editingIndex] = data;
                editingIndex = -1;
                document.querySelector('.btn-submit').textContent = "Submit";
            } else {
                // Add new
                records.push(data);
            }

            localStorage.setItem(STORAGE_KEY, JSON.stringify(records));
            renderTable();
            clearForm(); // Clear inputs for next entry
        }

        function renderTable() {
            const records = JSON.parse(localStorage.getItem(STORAGE_KEY) || "[]");
            const thead = document.getElementById("tableHeader");
            const tbody = document.getElementById("tableBody");
            const countSpan = document.getElementById("recordCount");

            countSpan.textContent = records.length;

            let headerHTML = "";
            FIELD_MAP.forEach(f => headerHTML += `<th>${f[0]}</th>`);
            headerHTML += "<th>Action</th>";
            thead.innerHTML = headerHTML;

            tbody.innerHTML = "";
            if (records.length === 0) {
                tbody.innerHTML = `<tr><td colspan="${FIELD_MAP.length + 1}">No records.</td></tr>`;
                return;
            }

            records.forEach((r, idx) => {
                const tr = document.createElement("tr");
                let html = "";
                FIELD_MAP.forEach(f => {
                    if (f[1] === "id_idx") html += `<td>${idx + 1}</td>`;
                    else html += `<td>${r[f[1]] || ""}</td>`;
                });
                html += `<td>
                    <button class="btn-delete" style="padding:4px 8px; font-size:10px; background:#2196F3;" onclick="editRecord(${idx}); event.stopPropagation();">Edit</button>
                    <button class="btn-delete" style="padding:4px 8px; font-size:10px" onclick="deleteRecord(${idx}); event.stopPropagation();">Del</button>
                </td>`;
                tr.innerHTML = html;
                tr.style.cursor = "pointer";
                tr.onclick = () => togglePreview(idx);
                tr.id = `row-${idx}`;
                tbody.appendChild(tr);
            });
        }

        function togglePreview(idx) {
            const existing = document.getElementById(`preview-${idx}`);
            if (existing) {
                existing.remove();
                return;
            }

            const records = JSON.parse(localStorage.getItem(STORAGE_KEY) || "[]");
            const r = records[idx];
            if (!r) return;

            const row = document.getElementById(`row-${idx}`);
            const previewRow = document.createElement("tr");
            previewRow.id = `preview-${idx}`;
            previewRow.style.background = "#f9f9f9";

            let details = "<div style='display:grid; grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); gap:10px; padding:10px;'>";
            EXPORT_SCHEMA.forEach(col => {
                const val = r[col.id];
                if (val && col.header) {
                    details += `<div><strong>${col.header}:</strong> ${val}</div>`;
                }
            });
            details += "</div>";

            previewRow.innerHTML = `<td colspan="${FIELD_MAP.length + 1}">${details}</td>`;
            row.parentNode.insertBefore(previewRow, row.nextSibling);
        }

        function editRecord(index) {
            const records = JSON.parse(localStorage.getItem(STORAGE_KEY) || "[]");
            const data = records[index];
            if (!data) return;

            restoreForm(data);
            editingIndex = index;
            document.querySelector('.btn-submit').textContent = "Update";
            window.scrollTo(0, 0); // Scroll to top
        }

        function restoreForm(data) {
            clearForm(); // Reset first

            // Restore basic inputs
            ALL_FIELDS.forEach(id => {
                const el = document.getElementById(id);
                if (data[id]) {
                    if (el) el.value = data[id];

                    // Also update associated Selects (e.g. GradYear -> GradYearSelect)
                    const linkedSelect = document.getElementById(id + "Select");
                    if (linkedSelect) linkedSelect.value = data[id];
                }
            });

            // Restore Radios (e.g., Q1, Q2...)
            // Matches name="radio_ID"
            document.querySelectorAll("input[type=radio]").forEach(rad => {
                // Name format: radio_Q1, radio_Q2...
                const qId = rad.name.replace("radio_", "");
                if (data[qId] === rad.value) {
                    rad.checked = true;
                }
            });

            // Restore Checkboxes (Q4, Q5... multi-selects stored usually as comma strings in hidden input)
            // We need to re-check the boxes based on the hidden input value we just restored.
            // Iterate all hidden inputs that might be multi-selects
            document.querySelectorAll("input[type=hidden]").forEach(hidden => {
                const val = hidden.value;
                if (!val) return;

                // Find associated checkboxes - loosely by looking for inputs with values present in the string?
                // Or finding the container? The checkbox logic doesn't explicitly link ID to container rigidly in HTML structure.
                // But `updateMulti` works by `closest`.
                // We know the checkboxes update the hidden input.
                // So we can find checkboxes that would update THIS hidden input? No simpler:
                // If hidden id is "Q4", find checkboxes that update "Q4"? 
                // The onchange="updateMulti('Q4'...)" tells us.

                const selector = `input[type='checkbox'][onchange*="'${hidden.id}'"]`;
                const checkboxes = document.querySelectorAll(selector);
                if (checkboxes.length > 0) {
                    const values = val.split(',').map(v => v.trim()); // comma or empty?
                    // Q13 uses comma. Others might be empty string joined?
                    // My previous `updateMulti` logic:
                    // const delimiter = (fieldId === 'Q13') ? "," : "";
                    // So we need to handle that.

                    checkboxes.forEach(chk => {
                        // Check if chk.value is in the string.
                        // If no delimiter, string is "ABC". values=["A","B","C"] logic?
                        // Or straight "ABC".includes(chk.value)?
                        // Yes, if value is single char.
                        // Q13 values are "1", "2"... "71". Comma separated.
                        if (hidden.id === 'Q13') {
                            if (values.includes(chk.value)) chk.checked = true;
                        } else {
                            // No delimiter string "ABC".
                            if (val.includes(chk.value)) chk.checked = true;
                        }
                    });
                }
            });
        }

        function clearStorage() {
            if (confirm("Delete all data?")) {
                localStorage.removeItem(STORAGE_KEY);
                clearForm(); // Clear the form inputs as well
                renderTable();
            }
        }

        function clearForm() {
            // document.getElementById("acteForm").reset(); // Correctly clearing manually below

            // Clear all text/number inputs manually just in case
            document.querySelectorAll("input[type=text], input[type=email]").forEach(i => {
                // Don't clear disabled fixed fields
                if (!i.disabled) i.value = "";
            });

            // Clear hidden inputs
            document.querySelectorAll("input[type=hidden]").forEach(i => i.value = "");

            // Uncheck all radios/checkboxes
            document.querySelectorAll("input[type=checkbox], input[type=radio]").forEach(i => i.checked = false);

            // Reset Selects
            document.querySelectorAll("select").forEach(s => s.selectedIndex = 0);

            // Reset Start Time for new record
            startTime = new Date();

            // Reset Editing State
            editingIndex = -1;
            document.querySelector('.btn-submit').textContent = "Submit";
        }

        function downloadExcel() {
            const records = JSON.parse(localStorage.getItem(STORAGE_KEY) || "[]");
            if (records.length === 0) {
                alert("No data.");
                return;
            }

            // Map records to export schema
            const dataToExport = records.map(r => {
                // Return array of values based on EXPORT_SCHEMA order
                return EXPORT_SCHEMA.map(col => {
                    if (col.id === null) return ""; // Empty column
                    return r[col.id] || "";
                });
            });

            // Add Header Row
            const headerRow = EXPORT_SCHEMA.map(col => col.header);
            dataToExport.unshift(headerRow);

            const worksheet = XLSX.utils.aoa_to_sheet(dataToExport);
            const workbook = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(workbook, worksheet, "ACTE_Data");
            XLSX.writeFile(workbook, `ACTE_Data_${new Date().toISOString().slice(0, 10)}.xlsx`);
        }
    </script>
</body>


</html>
